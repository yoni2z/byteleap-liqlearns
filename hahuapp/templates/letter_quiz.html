{% extends "base.html" %} {% block content %}
<div class="text-center">
  <h2 class="fw-bold">Letter Quiz</h2>
  <h3>Identify the letters that are called out from the choices</h3>

  <!-- Play each letter sound -->
  {% for sound in sounds %}
  <div class="my-3">
    <audio controls>
      <source src="{{ sound.sound_field.url }}" type="audio/mpeg" />
      Your browser does not support the audio element.
    </audio>
  </div>
  {% endfor %}

  <!-- Letter Choices -->
  <div class="d-flex justify-content-center flex-wrap mt-4">
    {% for choice in choices %}
    <button
      class="btn btn-outline-primary m-2 letter-choice"
      data-letter="{{ choice.letter }}"
    >
      {{ choice.letter }}
    </button>
    {% endfor %}
  </div>

  <!-- Progress Bar -->
  <div class="progress mt-4" style="height: 30px; width: 60%; margin: 0 auto">
    <div
      id="progress-bar"
      class="progress-bar progress-bar-striped"
      role="progressbar"
      style="width: 0%"
      aria-valuemin="0"
      aria-valuemax="100"
    >
      0%
    </div>
  </div>

  <!-- Feedback and Continue Button -->
  <div
    class="mt-4 d-flex justify-content-center align-items-center flex-column"
  >
    <p id="feedback" class="mt-3" style="display: none"></p>
    <a
      href="{% url 'word-matching' %}"
      id="continue-button"
      class="btn btn-success mt-3"
      style="display: none"
    >
      Continue
    </a>
  </div>
</div>

<script>
  const correctLetters = new Set({{ correct_letters|safe }});
  const selectedLetters = new Set();
  const progressBar = document.getElementById('progress-bar');
  const feedback = document.getElementById('feedback');
  const continueButton = document.getElementById('continue-button');
  const letterButtons = document.querySelectorAll('.letter-choice');

  function updateProgress() {
    const correctSelections = [...selectedLetters].filter(l => correctLetters.has(l)).length;
    const percentage = Math.floor((correctSelections / correctLetters.size) * 100);
    progressBar.style.width = `${percentage}%`;
    progressBar.textContent = `${percentage}%`;
  }

  function disableAllButtons() {
    letterButtons.forEach(button => {
      button.disabled = true; // Disable all buttons
      if (correctLetters.has(button.getAttribute('data-letter'))) {
        button.style.transform = 'scale(1.5)'; // Zoom in on correct letters
        button.style.transition = 'transform 0.5s'; // Smooth zoom transition
      }
    });
  }

  function showAlert(message, type = 'success') {
    feedback.style.display = 'block';
    feedback.textContent = message;
    feedback.className = `alert alert-${type} mt-3`;
  }

  letterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const letter = button.getAttribute('data-letter');

      // Toggle letter selection
      if (selectedLetters.has(letter)) {
        selectedLetters.delete(letter);
        button.classList.remove('btn-success', 'btn-danger');
        button.classList.add('btn-outline-primary');
      } else {
        selectedLetters.add(letter);
        button.classList.remove('btn-outline-primary');
        button.classList.add(
          correctLetters.has(letter) ? 'btn-success' : 'btn-danger'
        );
      }

      // Update the progress bar in real time
      updateProgress();

      // Check if incorrect letters are selected
      const hasIncorrect = [...selectedLetters].some(l => !correctLetters.has(l));
      if (hasIncorrect) {
        showAlert('Incorrect selection, try again.', 'danger');
        feedback.style.color = "red";
      } else {
        feedback.style.display = 'none';
      }

      // Check if the selection is fully correct
      const allCorrectSelected =
        [...correctLetters].every(l => selectedLetters.has(l)) &&
        selectedLetters.size === correctLetters.size;

      if (allCorrectSelected && !hasIncorrect) {
        showAlert('Correct! Well done.', 'success');
        continueButton.style.display = 'block';
        feedback.style.color = "green";
        disableAllButtons(); // Disable buttons and zoom correct letters
      }
    });
  });
</script>
{% endblock %}
