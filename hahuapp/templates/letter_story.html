{% extends "base.html" %}

{% block content %}

<div class="container mt-5">
  <h3>Create a meaningful Word or Sentence using all the given words</h3>
  
  <p><strong>Given letters: </strong> 
    <span id="letters">
      {% for letter in selected_letters %}
        {{ letter.letter }}
        {% if not forloop.last %}, {% endif %}
      {% endfor %}
    </span>
  </p>

  <textarea id="storyInput" rows="3" class="form-control" 
            placeholder="Type your word or sentence here"></textarea>
  
  <button id="submitButton" class="btn btn-primary mt-3">Submit</button>

  <div id="message" class="mt-3"></div>

  <button id="editButton" class="btn btn-warning mt-3 d-none">Edit</button>
  <a href="{% url 'letter-fill-in-the-blanks-2' %}" id="continueButton" class="btn btn-success mt-3 d-none">Continue</a>
</div>

<script>
  const submitButton = document.getElementById('submitButton');
  const storyInput = document.getElementById('storyInput');
  const messageDiv = document.getElementById('message');
  const editButton = document.getElementById('editButton');
  const continueButton = document.getElementById('continueButton');
  
  const letters = document.getElementById('letters').innerText.split(', ');

  // Normalize letters (if necessary) to handle case sensitivity
  const normalizedLetters = letters.map(letter => letter.trim()); // Keep original letters

  // Validate that all given letters are used in the story
  function validateStory(story, letters) {
    const normalizedStory = story.replace(/\s+/g, ''); // Remove spaces from input story
    const storySet = new Set(normalizedStory); // Create a set of characters from the input story

    // Check if each required letter exists in the input story
    for (const letter of letters) {
      if (!storySet.has(letter)) {
        return false; // Return false if any letter is missing
      }
    }
    return true; // All letters are present
  }

  submitButton.addEventListener('click', () => {
    const story = storyInput.value.trim(); // Keep original input

    if (validateStory(story, normalizedLetters)) {
      // Success: All letters are used
      messageDiv.innerHTML = '<p class="alert alert-success">Good Work. Listen to the verification from your teacher.</p>';
      storyInput.disabled = true;
      editButton.classList.remove('d-none');
      continueButton.classList.remove('d-none');
    } else {
      // Failure: Missing some letters
      messageDiv.innerHTML = '<p class="alert alert-danger">Please use all the listed letters.</p>';
    }
  });

  editButton.addEventListener('click', () => {
    storyInput.disabled = false;
    storyInput.focus();
    messageDiv.innerHTML = ''; // Clear previous message
  });

  continueButton.addEventListener('click', () => {
    window.location.reload(); // Reload page for new letters
  });
</script>

{% endblock %}