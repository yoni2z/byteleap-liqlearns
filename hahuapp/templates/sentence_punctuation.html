{% extends 'base.html' %} {% block content %}
<div class="container text-center mt-5">
  <h2>Insert the Correct Punctuation</h2>
  <p>[drag and drop it in the sentence]</p>

  <div class="mt-4">
    <p id="sentence">
      <!-- Display the unpunctuated sentence with placeholders for drag and drop -->
      {{ sentence|safe }}
    </p>
  </div>

  <div class="d-flex justify-content-center mt-4">
    <div class="row w-50">
      {% for choice in choices %}
      <div class="col-4 mb-3 d-flex justify-content-center">
        <button
          class="btn choice-button"
          id="choice-{{ forloop.counter }}"
          data-punctuation="{{ choice }}"
          draggable="true"
          style="
            width: 100%;
            font-size: 24px;
            background: linear-gradient(to bottom, #ffefd5, #ffe4b5);
          "
        >
          {{ choice }}
        </button>
      </div>
      {% endfor %}
    </div>
  </div>

  <div id="feedback" class="alert text-center mt-3" style="display: none"></div>

  <div
    class="text-center d-flex justify-content-center align-items-center mt-4"
  >
    <a
      href="{% url 'sentence-punctuation' %}"
      id="next-button"
      class="btn btn-success w-25"
      style="display: none"
    >
      Continue
    </a>
  </div>
</div>

<script>
  const correctAnswer = "{{ correct_answer|escapejs }}";
  const correctText = "{{ correct_text|escapejs }}";
  const feedback = document.getElementById("feedback");
  const nextButton = document.getElementById("next-button");
  const sentenceElement = document.getElementById("sentence");

  let draggedItem = null;
  let isMobile = false;

  // Detect if the user is on a touch-enabled device
  if ("ontouchstart" in window || navigator.maxTouchPoints) {
    isMobile = true;
  }

  // Function to handle the drop logic
  function handleDrop(target) {
    const droppedItem = draggedItem;

    // Check if the dropped item matches the correct punctuation
    if (droppedItem.getAttribute("data-punctuation") === correctAnswer) {
      feedback.textContent = "Good work!";
      feedback.className = "alert alert-success text-center mt-3";
      feedback.style.display = "block";

      // Update sentence with correct punctuation
      sentenceElement.innerHTML = correctText;
      sentenceElement.style.fontWeight = "bold";

      droppedItem.style.borderColor = "green"; // Highlight the button

      nextButton.style.display = "block";
      disableAllButtons();
    } else {
      feedback.textContent = "Try again!";
      feedback.className = "alert alert-danger text-center mt-3";
      feedback.style.display = "block";

      // Reset button highlight after 1 second
      droppedItem.style.borderColor = "red";
      setTimeout(() => {
        droppedItem.style.borderColor = "";
      }, 1000);
    }
  }

  // Standard drag-and-drop for desktops
  if (!isMobile) {
    document.querySelectorAll(".choice-button").forEach((button) => {
      button.addEventListener("dragstart", (event) => {
        draggedItem = event.target; // Store the dragged item
      });
    });

    sentenceElement.addEventListener("dragover", (event) => {
      event.preventDefault();
    });

    sentenceElement.addEventListener("drop", (event) => {
      event.preventDefault();
      handleDrop(event.target);
    });
  }

  // Touch-based drag-and-drop for mobile devices
  if (isMobile) {
    document.querySelectorAll(".choice-button").forEach((button) => {
      button.addEventListener("touchstart", (event) => {
        draggedItem = event.target;
        draggedItem.style.opacity = "0.5"; // Optional visual feedback
      });

      button.addEventListener("touchmove", (event) => {
        event.preventDefault();
        const touch = event.touches[0];
        draggedItem.style.position = "absolute";
        draggedItem.style.left = `${
          touch.pageX - draggedItem.offsetWidth / 2
        }px`;
        draggedItem.style.top = `${
          touch.pageY - draggedItem.offsetHeight / 2
        }px`;
      });

      button.addEventListener("touchend", (event) => {
        draggedItem.style.opacity = ""; // Reset opacity
        draggedItem.style.position = ""; // Reset position
        draggedItem.style.left = "";
        draggedItem.style.top = "";

        const target = document.elementFromPoint(
          event.changedTouches[0].clientX,
          event.changedTouches[0].clientY
        );

        // Check if the touch ended over the sentence element
        if (sentenceElement.contains(target)) {
          handleDrop(target);
        }
      });
    });
  }

  // Disable all buttons after a correct answer
  function disableAllButtons() {
    document.querySelectorAll(".choice-button").forEach((button) => {
      button.disabled = true;
    });
  }
</script>
{% endblock %}
