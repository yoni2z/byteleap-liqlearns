{% extends 'base.html' %} {% block content %}
<div class="container mt-5">
  <h2 class="text-center fw-bold">Word Matching</h2>
  <h4 class="text-center">
    Please select each word and match it with the corresponding definition that
    is appropriate.
  </h4>

  <div class="row">
    <div class="col-md-6">
      <h4>Words</h4>
      <ul id="word-list" class="list-group">
        {% for word in selected_words %}
        <li
          id="word-item"
          class="list-group-item word-item"
          data-word="{{ word.word }}"
          onclick="selectWord(this)"
        >
          {{ word.word }}
        </li>
        {% endfor %}
      </ul>
    </div>

    <div class="col-md-6">
      <h4>Definitions</h4>
      <ul id="definition-list" class="list-group">
        {% for definition in definitions %}
        <li
          id="definition-item"
          class="list-group-item definition-item"
          data-definition="{{ definition }}"
          onclick="selectDefinition(this)"
        >
          {{ definition }}
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <button
    id="submit-btn"
    class="btn btn-primary mt-4"
    onclick="submitAnswers()"
  >
    Submit
  </button>
  <button
    id="try-again-btn"
    class="btn btn-secondary mt-4 d-none"
    onclick="tryAgain()"
  >
    Try Again
  </button>

  <p
    id="feedback"
    class="mt-3 text-center alert alert-success"
    style="display: none"
  ></p>

  <div class="progress mt-4" style="height: 30px; width: 60%; margin: 0 auto">
    <div
      id="progress-bar"
      class="progress-bar progress-bar-striped"
      role="progressbar"
      style="width: 0%"
      aria-valuemin="0"
      aria-valuemax="100"
    >
      0%
    </div>
  </div>

  <div class="text-center">
    <a
      href="{% url 'word-hunt' %}"
      id="continue-btn"
      class="btn btn-success text-center w-25 mt-4 d-none"
    >
      Continue
    </a>
  </div>
</div>

<script>
  let selectedWord = null;
  let selectedDefinition = null;
  let matchedPairs = {};
  let pairColors = {};
  let colorIndex = 0;

  const correctPairs = JSON.parse(JSON.stringify({{ correct_pairs|safe }}));

  const colors = ["#f9d6d2", "#c3e6cb", "#f1e8e6", "#d1ecf1", "#c8d6e5"];

  function selectWord(element) {
    clearSelections("word-item");
    element.classList.add("selected");
    selectedWord = element.getAttribute("data-word");
    highlightPair();
  }

  function selectDefinition(element) {
    clearSelections("definition-item");
    element.classList.add("selected");
    selectedDefinition = element.getAttribute("data-definition");
    highlightPair();
  }

  function highlightPair() {
    if (selectedWord && selectedDefinition) {
      matchedPairs[selectedWord] = selectedDefinition;

      // Assign color for the pair if not already assigned
      if (!pairColors[selectedWord]) {
        pairColors[selectedWord] = colors[colorIndex % colors.length];
        colorIndex++;
      }

      const wordElement = document.querySelector(`[data-word="${selectedWord}"]`);
      const defElement = document.querySelector(`[data-definition="${selectedDefinition}"]`);

      // Set the background color for both elements
      wordElement.style.backgroundColor = pairColors[selectedWord];
      defElement.style.backgroundColor = pairColors[selectedWord];

      selectedWord = null;
      selectedDefinition = null;
    }
  }

  function clearSelections(className) {
    const elements = document.getElementsByClassName(className);
    for (const element of elements) {
      element.classList.remove("selected");
    }
  }

  function submitAnswers() {
    let correctCount = 0;

    for (const word in matchedPairs) {
      const definition = matchedPairs[word];
      if (correctPairs[word] === definition) {
        correctCount++;
        highlightCorrect(word, definition);
      } else {
        highlightIncorrect(word, definition);
      }
    }

    const percentage = (correctCount / Object.keys(correctPairs).length) * 100;
    document.getElementById("progress-bar").style.width = `${percentage}%`;
    document.getElementById("progress-bar").textContent = `${percentage.toFixed(0)}%`;

    if (correctCount === Object.keys(correctPairs).length) {
      document.getElementById("feedback").style.display = "block";
      document.getElementById("feedback").textContent = "Great work! All pairs are correct!";
      document.getElementById("submit-btn").disabled = true;
      document.getElementById("continue-btn").classList.remove("d-none");
      disableSelections();
    } else {
      document.getElementById("feedback").textContent = "Some answers are incorrect. Try again!";
      document.getElementById("try-again-btn").classList.remove("d-none");
    }
  }

  function highlightCorrect(word, definition) {
    const wordElement = document.querySelector(`[data-word="${word}"]`);
    const defElement = document.querySelector(`[data-definition="${definition}"]`);
    wordElement.style.backgroundColor = "#d4edda"; // Green for correct
    defElement.style.backgroundColor = "#d4edda";
  }

  function highlightIncorrect(word, definition) {
    const wordElement = document.querySelector(`[data-word="${word}"]`);
    const defElement = document.querySelector(`[data-definition="${definition}"]`);
    wordElement.style.backgroundColor = "#f8d7da"; // Red for incorrect
    defElement.style.backgroundColor = "#f8d7da";
  }

  function tryAgain() {
    matchedPairs = {};
    pairColors = {};
    colorIndex = 0; // Reset color index
    clearSelections("word-item");
    clearSelections("definition-item");

    const wordItems = document.querySelectorAll(".word-item");
    const defItems = document.querySelectorAll(".definition-item");

    wordItems.forEach((item) => (item.style.backgroundColor = ""));
    defItems.forEach((item) => (item.style.backgroundColor = ""));

    document.getElementById("feedback").textContent = "";
    document.getElementById("try-again-btn").classList.add("d-none");
    enableSelections();
  }

  function disableSelections() {
    const wordItems = document.querySelectorAll(".word-item");
    const defItems = document.querySelectorAll(".definition-item");
    wordItems.forEach(item => item.style.pointerEvents = 'none');
    defItems.forEach(item => item.style.pointerEvents = 'none');
  }

  function enableSelections() {
    const wordItems = document.querySelectorAll(".word-item");
    const defItems = document.querySelectorAll(".definition-item");
    wordItems.forEach(item => item.style.pointerEvents = 'auto');
    defItems.forEach(item => item.style.pointerEvents = 'auto');
  }
</script>

<style>
  .list-group-item.selected {
    background-color: #cce5ff; /* Light blue for selection */
    color: #004085;
  }

  .progress-bar {
    transition: width 0.5s;
  }
</style>
{% endblock %}
